- name: Get SSH keys
  hosts: all
  gather_facts: false
  connection: local
  vars:
    known_hosts: "~/.ssh/known_hosts"
  tasks:
    - name: Scan SSH Keys
      command: "ssh-keyscan -p {{ansible_port|default(22)}} {{ansible_host|default(inventory_hostname)}}"
      register: "host_keys"
      changed_when: false

- name: Create known hosts file
  hosts: localhost
  gather_facts: false
  vars:
    known_hosts: "~/.ssh/known_hosts"
  tasks:
    - name: Stat known_hosts file for existance
      stat: path="{{ known_hosts }}"
      register: fstat

    - name: Create known_hosts file if non-existing
      copy: content="\n" dest="{{ known_hosts }}"
      when: "not fstat.stat.exists"
      changed_when: false

    - name: Add SSH Keys to known_hosts
      blockinfile:
        dest: "{{known_hosts}}"
        marker: "# {mark} GENERATED BY ANSIBLE"
        block: |
          {% for h in groups['all'] if hostvars[h].host_keys is defined and hostvars[h].host_keys.stdout is defined %}
          {{ hostvars[h].host_keys.stdout }}
          {% endfor %}
